\documentclass[10pt]{article}
\usepackage[margin=0.75in]{geometry}
\usepackage{makecell}
\usepackage{longtable}
\usepackage{amsmath, amssymb}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{tikz}
\usepackage{tcolorbox}
\tcbuselibrary{skins, breakable}

\include{styles/bashconsole}
\include{styles/flowchart}
\include{styles/assembly}

\setlength{\parindent}{0pt}

\title{Visualiser Documentation}
\author{Ruben Saunders}
\date{November 2024}

\begin{document}
    \maketitle
    \tableofcontents

    \newpage

    \section{Overview}

    The visualiser offers an interactive view into code execution and the interaction between the compiler, the assembler, and the processor.
    The visualiser
    \begin{itemize}
        \item Is machine-code executor, able to run the loaded binary on the processor in a step-wise fashion.
        \item Has a register view/editor.
        \item Has a memory view/editor.
        \item Is a basic debugger.
        \item Shows the current machine-code instruction, and back-traces it to both the assembly and high-level source code.
    \end{itemize}

    The application is a TUI (a textual user interface), meaning it runs in the terminal.
    The interface is tab-based, with a navigation bar along the top.
    Later sections will cover the content of each tab.

    \subsection{Command-Line Interface}

    The visualiser executable is called as follows:

    \medskip
    \begin{lstlisting}[style=bashconsole]
$ ./visualiser [filename] [flags]
    \end{lstlisting}

    If a filename is provided, this is assumed to be the root name of all components: \texttt{filename.edel}, \texttt{filename.asm}, \texttt{filename.s}, and \texttt{filename} (binary).
    Each file may be provided using a flag which will override the assumption:
    \begin{itemize}
        \item \texttt{--edel <file>} -- sets the input high-level Edel source file.
        Default: \texttt{<filename>.edel}.
        \item \texttt{--asm <file>} -- sets the input assembly source file.
        Expects output from the compiler.
        Default: \texttt{<filename>.asm}.
        \item \texttt{--reconstructed <file>} -- sets the reconstructed assembly file.
        Expects \texttt{-r ...} file from the assembler.
        Default: \texttt{<filename>.s}.
        \item \texttt{--bin <file>} -- sets the binary file.
        Expects output from the assembler.
        Default: \texttt{<filename>}.
    \end{itemize}

    There are some additional flags available:
    \begin{itemize}
        \item \texttt{-b <list>} or \texttt{--breakpoints <list>} -- a comma-separated list of \$pc values to install breakpoints at.
        \item \texttt{--stdout <file>} -- pipe the processor's output to this file.
        \item \texttt{--stdin <file>} -- set the processor's input stream to this file.
    \end{itemize}

    \subsection{Execution Example}

    Below is the sequence of steps to go from a source Edel file to running it on the visualiser.

    \begin{enumerate}
        \item Write a high-level source file, say \texttt{source.edel}.
        \item Compile the file, emitting debug comments.
        The following command will output an assembly file, \texttt{source.asm}.
        \begin{lstlisting}[style=bashconsole]
$ ./compiler source.edel -o source.asm -d
        \end{lstlisting}
        \item Assemble the file, emitting a reconstruction.
        The following command will output a binary, \texttt{source}, and a reconstruction mapping, \texttt{source.s}.
        \medskip
        \begin{lstlisting}[style=bashconsole]
$ ./assembler source.asm -o source -r source.s
        \end{lstlisting}
        \item Launch the visualiser.
        If all the file names are the same, with the correct extensions, we can simply pass the file name without an extension.
        \medskip
        \begin{lstlisting}[style=bashconsole]
$ ./visualiser source
        \end{lstlisting}
    \end{enumerate}

    \subsection{Navigation \& Control Basics}

    As a TUI, everything may be done using keyboard controls.
    Navigation between key elements is done with the arrow keys (e.g., navigating between tabs, selecting registers in the list).

    To use the tab-specific controls, the tab body must be focused.
    This can be achieved by pressing the down arrow.
    Key controls are detailed in this document; however, a summary of controls for each tab are listed at the bottom of the screen.

    Aside from tab-specific controls, the following are global:
    \begin{itemize}
        \item \texttt{Ctrl+c} -- exits the application.
        \item \texttt{F\(n\)} -- selects the \(n^{th}\) tab.
    \end{itemize}

    \section{Code Execution}

    The ``main'' tab, this view shows the source and compiler assembly side-by-side.

    \subsection{Layout}

    At the top of the screen are two checkboxes, one which toggles line selection, and the other which determines if the processor is currently running.
    Below this is the source code of the processor, split into the following panes:
    \begin{itemize}
        \item The assembly source is displayed on the left, with its file name displayed.
        \item The reconstructed compiler assembly is display on the right.
    \end{itemize}
    The current line pointed to by \$pc is highlighted in yellow, which is traced back to the source assembly.
    If enabled, the currently selected line is displayed in cyan, with the corresponding equivalent lines highlighted in light cyan in the other pane.
    Breakpoints are indicated by a {\color{red} \(\bullet\)} preceding the line.

    Below this is a section for the processor's debug messages, which is hidden by default unless messages are available.
    The fields below this display the
    \begin{itemize}
        \item Processor's status -- either \textit{halted} or \textit{running}.
        This reflects the \texttt{is\_running} bit in \$flag.
        \item Cycle -- indicates the processor's current cycle, i.e., number of executed steps.
        \item Program counter -- the current value of \$pc.
    \end{itemize}

    \subsection{Keyboard Controls}

    The pane's displaying file contents behave as scrollable windows.
    They may be navigated by the arrow keys as well as by the scroll wheel.

    \begin{itemize}
        \item \texttt{Return} -- commends the fetch-execute cycle, executes until a breakpoint is encountered or the program halts.
        \item \texttt{Space} -- executes the current line.
        In the machine code pane, this is equivalent to a single CPU cycle.
        \item \texttt{b} -- toggles a breakpoint for the selected line.
        \item \texttt{h} -- toggles the \texttt{is\_running} bit in \$flag.
        \item \texttt{j} -- if line selection is enabled, sets \$pc to the first selected line in the compiled assembly.
        \item \texttt{r} -- resets \$flag: sets \texttt{is\_running} and clears any error bits.
        \item \texttt{s} -- toggle line selection.
    \end{itemize}

    \section{Registers}

    This view shows a list of the processor's registers.

    \subsection{Layout}

    The left-hand side of the view displays a list of the processor's registers, accompanied by their 64-bit hexadecimal value.
    This list is divided into two groups: special registers, and general purpose registers.
    When a register is selected, more information about that register is display in a pane on the right.
    This pane lists the register's value in hexadecimal, as a decimal integer (32-bit) and long (64-bit), as a float, and as a double.
    Each may be edited and updated.
    A brief description of the register is given below this.

    The \$flag register has an additional section below this.
    \$flag contains state information about the processor, which are listed in a decomposed form here.

    \subsection{Keyboard Controls}

    When an input field is selected, controls work as they ordinarily would in an input box, overriding the below.

    \begin{itemize}
        \item \texttt{1-9} -- select register \texttt{\$r\(n\)}.
        \item \texttt{Backspace/Delete} -- zeroes the current register.
        \item \texttt{c} -- copies the contents of the current register.
        \item \texttt{r} -- refresh all registers, and the selected register's pane.
        Useful when a register value has been updated in another tab, and changes have not been loaded.
        \item \texttt{Up/Down arrows} -- scroll in the register list.
        \item \texttt{v} -- paste the copied register's value into the current register.
    \end{itemize}

    \section{Memory}

    This view displays a section of memory in a grid view.

    \subsection{Layout}

    The main component in this tab is the grid of memory cells.
    Violet values along the side indicate the base address of each row, with the values along the top marking offsets.
    The range of addresses shown in this grid are indicates in the title.

    Once the grid is focused, the current address will be highlighted.
    Moving this cursor will be detailed in the next section, but note that if the user tries to move the cursor beyond the view's borders, the view will attempt to scroll if possible.
    Additionally, the value of \$pc is highlighted in yellow.

    Below the grid is a dropdown and textbox, used for viewing and editing memory more than one byte at a time.
    The dropdown dictates the datatype of the data being read.
    This may be changed by focusing the dropdown and pressing \texttt{Enter}, then using the arrow keys to navigate the list, and pressing \texttt{Enter} again to select the value.
    The textbox next to this displays data of this type.
    If this section is focused, the bytes being read are highlighted in the memory view.

    \subsection{Keyboard Controls}

    These controls only take effect when the memory grid is in focus.

    \begin{itemize}
        \item \texttt{[0-9a-zA-Z]} -- modifies the byte in memory.
        Specifically, the lower four bits are overwritten with this value, while the old bytes are shifted into the upper half.
        \item Arrow keys -- navigate the memory view, moving the cursor in the given direction.
        \item \texttt{Backspace/Delete} -- zeroes the current byte.
        \item \texttt{Ctrl+PageUp/Down} -- navigates to the absolute start/end of the processor's memory region.
        \item \texttt{Enter} -- move focus to the textbox.
        \item \texttt{Home/End} -- navigate to the start/end of the current line.
        \item \texttt{PageUp/Down} -- navigates to the start/end of the memory view.
        \item \texttt{Tab} -- move focus to the datatype dropdown.
    \end{itemize}

    \section{Sources}

    This tab displays all the source files used in the program.

    \subsection{Layout}

    The pane on the left categorises the files into which source layer they fit into:
    machine code (the reconstructed assembly provided via \texttt{--asm});
    assembly sources (files inputted to the assembler);
    and high-level source files (files inputted to the compiler).
    The list may be navigated to select files, wherein there contents are displayed on the right-hand pane.
    The number of breakpoints in a file, if any, are indicated by \(n \times\){\color{red}\(\bullet\)} preceding the filepath.

    The right-hand pane displays the contents of the selected file.
    The pane may be selected and arrow keys used to change which line is selected (the line highlighted in blue).
    The line containing the current \$pc is also highlighted in yellow.
    Breakpoints are indicated by a {\color{red}\(\bullet\)} preceding the line.

    \subsection{Keyboard Controls}

    \begin{itemize}
        \item \texttt{e} -- changes the file and line selection to point to the location of the current \$pc.
    \end{itemize}

    The following controls only take effect when the file pane is in focus.

    \begin{itemize}
        \item \texttt{[} and \texttt{]} -- both change the file and line selection by tracing the selected line forwards or backwards, respectively.
        That is, if a source (\texttt{.s}) line is selected, \texttt{[} will select the line in an assembly (\texttt{.asm}) source, whereas \texttt{]} does nothing.
        \item \texttt{b} -- toggle the breakpoint on the selected line.
        \item \texttt{j} -- jumps to the current line, i.e., sets \$pc to the location of the selected line.
    \end{itemize}

    \section{Settings}

    Contains various visualiser settings.

    \subsection{Layout}

    The tab contains several bordered windows, grouping common settings together.

    \paragraph*{Debug Flags}
    Controls the debug flags of the processor.
    For information, see the \texttt{-d...} flags in the processor documentation.

\end{document}
